# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: 2
project_name: opentelemetry-operations-collector

env:
  - LD_FLAGS=-s -w
  - CGO_ENABLED=1
  - BUILD_FLAGS=-trimpath
  - GOWORK=off

builds:
  - id: otelopscol-linux
    goos:
      - linux
    goarch:
      - "386"
      - amd64
      - arm64
    goarm:
      - "7"
    binary: otelopscol
    dir: _build
    ldflags:
      - "-s -w"
    flags:
      - "-trimpath"
      - "-buildvcs=false"

  - id: otelopscol-windows
    goos:
      - windows
    goarch:
      - amd64
      - arm64
    goarm:
      - "7"
    binary: otelopscol
    dir: _build
    ldflags:
      - "-s -w"
    flags:
      - "-trimpath"
      - "-buildvcs=false"

archives:
  - id: otelopscol
    builds:
      - otelopscol-linux
    name_template: '{{ .Binary }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}{{ if .Mips }}_{{ .Mips }}{{ end }}'
  - id: otelopscol-windows
    builds:
      - otelopscol-windows
    name_template: '{{ .Binary }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}{{ if .Mips }}_{{ .Mips }}{{ end }}'

nfpms:
  - package_name: otelopscol
    contents:
      - src: otelopscol.service
        dst: /lib/systemd/system/otelopscol.service
      - src: otelopscol.conf
        dst: /etc/otelopscol/otelopscol.conf
        type: config|noreplace
        file_info:
          mode: 0644
      - src: config.yaml
        dst: /etc/otelopscol/config.yaml
        type: config|noreplace
        file_info:
          mode: 0644
    scripts:
      preinstall: preinstall.sh
      postinstall: postinstall.sh
      preremove: preremove.sh
    overrides:
      rpm:
        dependencies:
          - /bin/sh
    id: otelopscol
    builds:
      - otelopscol-linux
    formats:
      - deb
      - rpm
    umask: 0
    maintainer: Google Cloud Platform <google@google.com> # something better than this
    description: OpenTelemetry Collector binary used by the Ops Agent
    license: Apache 2.0