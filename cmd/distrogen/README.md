# distrogen

This tool generates OpenTelemetry Collector distributions.

* Generates distributions from a simple yaml spec
* Features a full set of robust templates that most distributions will use
* Features a registry for all `opentelemetry-collector` and `opentelemetry-collector-contrib` components
* Allows you to provide your own templates and registry to build custom collectors that work for your use case

## Usage

Given a spec file such as:
```yaml
name: basic-distro
display_name: Basic OTel
version: 0.121.0
description: "A basic distribution of the OpenTelemetry Collector"
blurb: "A basic collector distro"
opentelemetry_version: 0.121.0
opentelemetry_stable_version: 1.27.0
binary_name: otelcol-basic
collector_cgo: false
go_version: 1.24.0

docker_repo: us-docker.pkg.dev/pretend-repo/otelcol-basic

components:
  receivers:
    - otlp
  processors:
    - batch
    - memorylimiter
  exporters:
    - otlp
  extensions:
    - pprof
  connectors:
    - forward
  providers:
    - yaml
```
Run `distrogen` with your spec:
```
distrogen -spec spec.yaml
```
It will generate a `basic-distro` directory. In that directory you can run `make build` to build a binary, or `make image-build` to build a binary as well as the resulting Docker container.

## Custom Registries

`distrogen` comes with a [registry embedded in the binary](./registry.yaml) that contains all [opentelemetry-collector](https://github.com/open-telemetry/opentelemetry-collector/blob/main/versions.yaml) and [opentelemetry-collector-contrib](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/versions.yaml) components. If you would like to provide components in other locations (local or in other repositories) you can provide your own registry files that will get merged with the embedded registry. If you provide any components with the same name, the component from your custom registry will override the entry in the embedded registry.

You can provide the following custom registry:
```yaml
receivers:
  # Provide an entry for a custom receiver
  custom:
    gomod: github.com/my-org/my-components/receiver/customreceiver v0.0.0
    docs_url: github.com/my-org/my-components/tree/main/receiver/customreceiver/README.md

processors:
  # Provide an entry that overwrites resourcedetection from the
  # embedded registry with a local copy.
  resourcedetection:
    gomod: github.com/open-telemetry/opentelemetry-collector-contrib/processor/resourcedetectionprocessor
    # The local path to the receiver based on the distribution
    # directory generated by distrogen.
    path: "../processor/resourcedetectionprocessor"
    docs_url: ../processor/resourcedetectionprocessor/README.md
```
And reference the component in your spec:
```yaml
name: basic-distro
display_name: Basic OTel
version: 0.121.0
description: "A basic distribution of the OpenTelemetry Collector"
blurb: "A basic collector distro"
opentelemetry_version: 0.121.0
opentelemetry_stable_version: 1.27.0
binary_name: otelcol-basic
collector_cgo: false
go_version: 1.24.0

docker_repo: us-docker.pkg.dev/pretend-repo/otelcol-basic

components:
  receivers:
    - otlp
    - custom
  processors:
    - batch
    - memorylimiter
    - resourcedetection
  exporters:
    - otlp
  extensions:
    - pprof
  connectors:
    - forward
  providers:
    - yaml
```
And finally, provide any number of registries to `distrogen` when generating:
```
distrogen -spec spec.yaml -registry registry.yaml # -registry another_registry.yaml to provide another
```

## Custom Templates

`distrogen` comes with a [sane set of templates embedded in the binary](./templates). These templates are rendered using the [a `TemplateContext` type as the context](./distribution.go).

If you want to provide additional templates, or you wish to override one of the templates provided by `distrogen`, you can provide a folder of your own templates. These templates must be named with a `.go.tmpl` extension to be recognized by the tool. If any templates in your custom folder have the same name/path as one of the templates embedded in `distrogen`, your custom template will override it. Custom templates will be rendered using the same `TemplateContext` type as the context.

Given a directory like this:
```
-rw-r----- 1 user user 1801 Mar 19 01:37 config.yaml.go.tmpl
-rw-r----- 1 user user 1726 Mar 20 01:54 Dockerfile.build.go.tmpl
drwxr-x--- 3 user user 4096 Mar 20 00:07 docs
-rw-r----- 1 user user  300 Mar 20 01:49 local.mk.go.tmpl
```
* `local.mk.go.tmpl` and `Dockerfile.build.go.tmpl` are new additional templates, and will be rendered along with the default templates
* `config.yaml.go.tmpl` matches the name of `config.yaml.go.tmpl` from the embedded template set, so the custom directory will be chosen instead
* `docs` is a directory with more templates, which will be rendered in the distribution folder with the same structure as they are in the template folder

Provide your custom template directory to `distrogen`:
```
distrogen -spec spec.yaml -custom_templates ./templates
```