# Distribution

A distribution/distro is a folder generated by distrogen that comes with:

* OCB config
* Compliant Dockerfiles
* goreleaser config
* Makefile for building
* Any additional templates provided by the user

With all this combined, you can build a custom Collector binary from a provided specification.

## Specification

The distribution specification is a YAML configuration file which `distrogen` uses to fill out the various templates it generates. 

### Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `name` | string | | The name for the distribution. |
| `display_name` | string | | A human-readable name to use for the distribution. It is used in the title for the generated README.  |
| `description` | string | | The human readable description of the distribution. It also gets formatted into the default user agent for `otlp` and `otlphttp` exporters. |
| `blurb` | string | | An optional description of the distribution to go in the generated README. |
| `binary_name` | string | | The name of the resulting built binary. Also used for the Docker image tag. |
| `opentelemetry_version` | string | | The OpenTelemetry Collector repository version that the distribution is based off of. |
| `opentelemetry_contrib_version` | string | The value of `opentelemetry_version` | The OpenTelemetry Collector Contrib repository version that the distribution is based off of. This is only occasionally necessary for times when contrib gets patch released while the core repo remains at its version. A majority of the time, this can be left blank as it will be the same version of core and contrib being used. |
| `opentelemetry_stable_version` | string | | The stable version of the OpenTelemetry Collector repository that this distribution is based off of. It must line up with the `opentelemetry_version`, i.e. for `0.138.0` of the core repository the stable version was `1.44.0`. The plan is for this to be autodetected, but that feature isn't implemented as of writing. |
| `version` | string | | The version of the distribution. This is the version that gets printed out if you call `--version` on the resulting binary, and will be used as the version of the pushed image. |
| `go_version` | string | | The Go version to use. This gets used if you leverage the automatic Go installation in the distribution build process. |
| `boringcrypto` | bool | false | Whether to build the binary with [BoringCrypto](https://csrc.nist.gov/CSRC/media/projects/cryptographic-module-validation-program/documents/security-policies/140sp3678.pdf). |
| `collector_cgo` | bool | false | Whether to build the binary with `CGO_ENABLED=1`. This must be true if `boringcrypto` is turned on. |
| `build_container` | enum | `debian` | The base to use for the `Dockerfile.build` container's build layer. Only `debian` and `alpine` are supported right now. |
| `feature_gates` | string[] | | The [`featuregates`](https://github.com/open-telemetry/opentelemetry-collector/tree/main/featuregate) to enable in the Collector. This is leveraged in the default `ENTRYPOINT` of image builds. |
| `components` | | | See [Components](#components). |
| `distrogen_version` | | | The version of the `distrogen` command to use. This is leveraged during [Project management](./project.md). |

### Components

The components section is a list of `receivers`, `processors`, `exporters`, `extensions`, and `connectors` to include in the distribution. Each entry in the lists are the name of a component from one of the configured [registries](./registry.md).

## Distribution Makefile

The Makefile comes with facilities for building the binary in different ways. Each target also has variables that you can provide via environment variables[^1] to customize behaviour.

### `build`

Builds a collector binary in place with the configured binary name.

[Tools](#tool-variables) used: `GO_BIN`, `OCB_BIN`

Leverages [Build Platform Variables](#build-platform-variables).

| Variable | Purpose | Default |
|----------|---------|---------|
| `COLLECTOR_BUILDVCS` | Go's `-buildvcs` flag value | false |
| `COLLECTOR_BUILD_TAGS` | Go's `-tags` flag value. | The `build_tags` field from distro spec. |
| `COLLECTOR_LD_FLAGS_STRIP` | Controls whether the binary is stripped/debuggable. | `-s -w`, i.e. stripped by default. If you need a debuggable binary, provide this variable as an empty value. |
| `COLLECTOR_LD_FLAGS_STATIC_LINK` | Controls whether the external static linking flags are provided. | If `boringcrypto` distro spec field is `true`, set to `-linkmode=external -extldflags=-static` i.e. the binary is statically linked by default. If you would prefer dynamic linking, provide this variable as an empty value. |
| `COLLECTOR_LD_FLAGS` | Additional values for Go's `-ldflags` value. | Empty. |

### goreleaser

The `goreleaser-release` target does a local goreleaser release using [the `snapshot` feature](https://goreleaser.com/customization/snapshots/). This target will be run directly on the machine.  
The `local-container-goreleaser` target also does a goreleaser release with `snapshot`, but within a temporary container based on `Dockerfile.goreleaser_releaser`. This means your build environment is entirely containerized. This is particularly useful for situations like `cgo_enabled` and `boring_crypto`, where `Dockerfile.goreleaser_releaser` will ensure to download the necessary C build toolchains. If you are using this target, it is recommended not to set any target variables. Please note that this target takes a very long time.

[Tools](#tool-variables) used: `GO_BIN`, `OCB_BIN`, `GORELEASER_BIN`

| Variable | Purpose | Default |
|----------|---------|---------|
| `GO_BIN_DIR` | The directory for `go install` to install binaries to. Leveraged by the `goreleaser` installation process. | Set to `.tools/go/bin`, which is where the default Go installation will end up. If you are providing your own Go installation, you should also provide either a `GO_BIN_DIR` or `SET_GO_BIN_PATH` variable. |
| `SET_GO_BIN_PATH` | Sets the `PATH` env var to include `GO_BIN_DIR` for the `goreleaser` invocation so that the installed `goreleaser` binary can be found. | Set to add `GO_BIN_DIR` to `PATH` by default. If you are providing your own Go or `goreleaser` installation, you can provide this variable with an empty value. |

### Docker Targets

The Docker targets are for building Collector image and pushing them to the configured Docker repo destination.

The `image-build` target will call [`build`](#build) first to build a Collector binary on the host machine which will then be copied into the container. This is good for local development,
and will likely be faster to build. 

The `image-build-full` target will use the alternate Dockerfile that actually builds the Collector binary
within an earlier image layer to copy to the resulting final image. The final image produced will look
the same as the other method; this is mostly for scenarios where you want to perform the entire
build process from within a Dockerfile without the host machine involved.

The `image-push` command will push the built image from either `image-build` or `image-build-full` (whichever you most recently ran) and
push it to the configured `docker_repo`.

The `image` and `image-full` are convenience targets that will first call `image-build` or `image-build-full` respectively followed by `image-push`.

The `image-build-cross-platform` target will build a multiplatform image for `linux/amd64` and `linux/arm64`. You must run `make multiplatform-builder` once to use this target.
(Making this automatic as part of the target would be nice, but isn't currently possible because
of the way the `buildx create` command works).  
Unlike the `image-build*` targets, the `image-build-cross-platform` target has to push due to the way the multiplatform building command works.
There is no available target to just do the cross-platform build without a subsequent push.

The following variables are shared by all targets.

[Tools](#tool-variables) used: `GO_BIN`, `OCB_BIN`.

Leverages [Build Platform Variables](#build-platform-variables).

| Variable | Purpose | Default |
|----------|---------|---------|
| `DOCKER_LOCAL_IMAGE_TAG` | The tag to use for the image in your local Docker cache. | `binary_name` from distro spec |
| `DOCKER_REPO` | The docker repo to push the built image to. | `docker_repo` from distro spec if set, otherwise empty. If empty and not provided, `image-push` will fail. |

### Tool Variables

Used to provide installations of tools so the Makefile doesn't install them itself. Shared across multiple targets.  
If any of these variables are not provided, the Makefile will install the tool locally into [the `.tools` directory](#tools-directory). (If the tool is already present in the `.tools` directory it won't reinstall)

The tools installations are affected by [Build Platform Variables](#build-platform-variables)
(specifically `BUILDOS` and `BUILDARCH` for the Go installation).

| Variable | Purpose | Default |
|----------|---------|---------|
| `GO_BIN` | Provide a path to a valid Go binary to use. | `.tools/go/bin/go`. Version of Go downloaded is controlled by the distro spec field `go_version`.  |
| `OCB_BIN` | Provide a path to a valid [`ocb`][ocb] binary to use. | `.tools/ocb`. Version of `ocb` downloaded is controlled by the distro spec field `opentelemetry_version`. |
| `GORELEASER_BIN` | Provide a path to a valid `goreleaser` binary to use. | `.tools/goreleaser`. Latest version is always installed. |

#### Tools Directory

All tools are downloaded to a local folder it creates called `.tools`. This folder should be added to a `.gitignore`.

### Build Platform Variables

Used to control multiplatform building. Shared across multiple targets.

| Variable | Purpose | Default |
|----------|---------|---------|
| `TARGETOS` | OS to target for build. | `linux` |
| `TARGETARCH` | Architecture to target for build. | `amd64` |
| `BUILDOS` | OS being used for build. | `linux` |
| `BUILDARCH` | Architecture being used for build. | `amd64` |

These variables are specified with the naming scheme of [Docker multi-platform build arguments](https://docs.docker.com/build/building/variables/#multi-platform-build-arguments). There are places where the Makefile will interpret these and use them as values for `GOOS` and `GOARCH`.

[^1]: The simplest method to provide an environment variable is inline. I.e. to provide `COLLECTOR_BUILDVCS` to `build`, the command line would look like `COLLECTOR_BUILDVCS=true make build`.

[ocb]: https://opentelemetry.io/docs/collector/custom-collector/