version: 2
project_name: opentelemetry-operations-collector

snapshot:
  version_template: {{ .Version }}

env:
  - GOWORK=off
  - CGO_ENABLED=0

builds:
  - id: {{ .BinaryName }}-linux
    {{- if .CollectorCGO }}
    env:
    - CGO_ENABLED=1
    {{ if .BoringCrypto -}}
    - GOEXPERIMENT=boringcrypto
    {{- end }}
    {{- end }}
    goos:
      - linux
    goarch:
      - amd64
      - arm64
    {{ if .BoringCrypto -}}
    overrides:
      - goos: linux
        goarch: arm64
        env:
          - CC=aarch64-linux-gnu-gcc
      - goos: linux
        goarch: amd64
        env:
          - CC=x86_64-linux-gnu-gcc
    {{- end }}
    ldflags:
      - "-s"
      - "-w"
      {{- if .BoringCrypto }}
      - "-linkmode=external"
      - "-extldflags=-static"
      {{- end }}
    flags:
      - "-trimpath"
      - "-buildvcs=false"
    binary: {{ .BinaryName }}
    dir: _build

  - id: {{ .BinaryName }}-windows
    goos:
      - windows
    goarch:
      - amd64
    binary: {{ .BinaryName }}
    flags:
      - "-trimpath"
      - "-buildvcs=false"
    dir: _build

nfpms:
  - package_name: {{ .BinaryName }}
    contents:
      - src: {{ .SystemdServiceName }}
        dst: /lib/systemd/system/{{ .SystemdServiceName }}
      - src: {{ .SystemdConfFileName }}
        dst: /etc/{{ .BinaryName }}/{{ .SystemdConfFileName }}
        type: config|noreplace
        file_info:
          mode: 0644
      - src: config.yaml
        dst: /etc/{{ .BinaryName }}/config.yaml
        type: config|noreplace
        file_info:
          mode: 0644
    scripts:
      preinstall: preinstall.sh
      postinstall: postinstall.sh
      preremove: preremove.sh
    overrides:
      rpm:
        dependencies:
          - /bin/sh
    ids:
      - {{ .BinaryName }}-linux
    formats:
      - deb
      - rpm
    umask: 0
    maintainer: Google Cloud Platform <google@google.com> # something better than this
    description: {{ .Description }}
    license: Apache 2.0
